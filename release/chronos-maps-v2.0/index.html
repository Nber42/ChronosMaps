<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Production URL: https://nber42.github.io/ChronosMaps/ -->
    <link rel="canonical" href="https://nber42.github.io/ChronosMaps/">

    <title>Chronos Maps | Explorador Viral</title>


    <!-- Google Fonts: Google Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Font Awesome (for legacy icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Legacy Styles (kept for compatibility) -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="poi_card.css">

    <!-- Feature Styles (should override legacy) -->
    <link rel="stylesheet" href="gmaps-style.css">
    <link rel="stylesheet" href="game-styles.css">
    <link rel="stylesheet" href="gmaps-style-dropdown-patch.css">
    <link rel="stylesheet" href="gmaps-style-reviews.css">
    <link rel="stylesheet" href="gmaps-style-directions.css">
    <link rel="stylesheet" href="nearby-scanner.css">
    <link rel="stylesheet" href="chronodex.css">
    <link rel="stylesheet" href="tours.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="ai-styles.css">
    <link rel="stylesheet" href="auth-styles.css">
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <span class="loading-logo">‚è±Ô∏è</span>
            <h1 class="loading-title">Chronos Maps</h1>
            <div class="loading-spinner"></div>
            <p class="loading-text">Cargando mapa...</p>
        </div>
    </div>

    <!-- GOOGLE MAPS LAYOUT -->

    <!-- Header Bar (Google Maps style) -->
    <header class="gmaps-header">
        <!-- Hamburger Menu -->
        <div style="position: relative;">
            <button class="gmaps-menu-btn" id="menu-btn" aria-label="Menu">
                <span class="material-icons">menu</span>
            </button>

            <!-- Dropdown Menu -->
            <nav class="gmaps-dropdown-menu" id="drawer">
                <ul class="gmaps-drawer-menu">
                    <li class="gmaps-drawer-item" onclick="closeDrawer()">
                        <span class="material-icons">explore</span>
                        <span>Explorar mapa</span>
                    </li>
                    <li class="gmaps-drawer-item" onclick="openChronodex(); closeDrawer();">
                        <span class="material-icons">collections_bookmark</span>
                        <span>Chronodex</span>
                    </li>
                    <li class="gmaps-drawer-item" onclick="ProfileSystem.open(); closeDrawer();">
                        <span class="material-icons">person</span>
                        <span>Tu perfil</span>
                    </li>
                    <li class="gmaps-drawer-item" onclick="TourSystem.openModal(); closeDrawer();">
                        <span class="material-icons">route</span>
                        <span>Rutas guiadas</span>
                    </li>
                    <div class="gmaps-drawer-divider"></div>
                    <li class="gmaps-drawer-item"
                        onclick="if(window.OpenAIService) { window.OpenAIService.showOpenAISetup(); closeDrawer(); }">
                        <span class="material-icons">settings</span>
                        <span>Configuraci√≥n AI</span>
                    </li>
                    <li class="gmaps-drawer-item">
                        <span class="material-icons">help</span>
                        <span>Ayuda y comentarios</span>
                    </li>
                    <div class="gmaps-drawer-divider"></div>
                    <li class="gmaps-drawer-item" onclick="AuthSystem.logout(); closeDrawer();" style="color: #ef4444;">
                        <span class="material-icons">logout</span>
                        <span>Cerrar Sesi√≥n</span>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Logo & Title -->
        <div class="gmaps-logo">
            <span class="gmaps-logo-icon">‚è±Ô∏è</span>
            <span class="gmaps-title">Chronos Maps</span>
        </div>

        <!-- Search Bar -->
        <div class="gmaps-search-container">
            <span class="material-icons gmaps-search-icon">search</span>
            <input type="text" id="gmaps-search-input" class="gmaps-search-input" placeholder="Buscar en Chronos Maps"
                autocomplete="off" />
            <button class="gmaps-voice-btn" aria-label="B√∫squeda por voz">
                <span class="material-icons">mic</span>
            </button>
            <div id="search-dropdown" class="search-dropdown"></div>
            <!-- Dropdown moved inside container for positioning -->
        </div>

        <!-- Space Filler -->
        <div style="flex:1"></div>

        <!-- User Avatar -->
        <div class="profile-avatar-modern" id="avatar-btn" onclick="handleProfileClick()">
            <div class="avatar-hexagon">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Agente" class="avatar-image"
                    id="header-avatar-img">
            </div>
            <div class="level-badge-modern">
                <span class="level-number" id="header-level-badge">1</span>
            </div>
        </div>
    </header>

    <!-- Side Panel (Drawer) -->
    <aside class="gmaps-side-panel" id="side-panel">
        <div id="info-display" style="display:none;"></div> <!-- Legacy hidden anchor for compatibility -->
        <div id="initial-state" style="display:none;"></div> <!-- Legacy hidden anchor for compatibility -->
        <div id="panel-back-nav" class="panel-back-nav hidden">
            <button class="back-button" onclick="goBack()">
                <span class="material-icons">arrow_back</span>
                <span>Volver</span>
            </button>
        </div>
        <div class="gmaps-panel-content" id="panel-content">
            <!-- Content injected dynamically -->
            <div class="gmaps-panel-empty">
                <span class="material-icons gmaps-empty-icon">place</span>
                <p>Selecciona un lugar en el mapa</p>
            </div>
        </div>
    </aside>

    <!-- Map Container (Full Screen) -->

    <!-- Map Container (Full Screen) -->
    <div id="chronos-map-canvas" class="gmaps-map-container"></div>

    <!-- Map Controls (Google Maps style) -->
    <!-- Map Controls (Google Maps style) -->
    <div class="gmaps-controls-container">
        <!-- Bottom Left: Layers -->
        <div class="gmaps-control-group bottom-left">
            <button class="gmaps-layers-btn" id="layers-btn" onclick="toggleLayersMenu()" aria-label="Capas"
                title="Capas">
                <span class="material-icons">layers</span>
            </button>
            <!-- Map Type Toggles (Mini) -->
            <div class="gmaps-mini-toggles">
                <button class="gmaps-mini-toggle active" onclick="setMapType('roadmap')">Mapa</button>
                <button class="gmaps-mini-toggle" onclick="setMapType('satellite')">Sat√©lite</button>
            </div>
        </div>

        <!-- Bottom Right: Zoom & Location & 3D -->
        <div class="gmaps-control-group bottom-right">
            <!-- 3D Toggle -->
            <button class="gmaps-fab-btn" id="view-toggle" onclick="toggle3DView()" aria-label="Vista 3D"
                title="Vista 3D / 2D">
                <span class="gmaps-3d-label">2D</span>
            </button>

            <!-- My Location -->
            <button class="gmaps-fab-btn location-btn" onclick="goToMyLocation()" aria-label="Mi ubicaci√≥n"
                title="Ir a mi ubicaci√≥n">
                <span class="material-icons">my_location</span>
            </button>

            <!-- Zoom Controls (Stacked) -->
            <div class="gmaps-zoom-stack">
                <button class="gmaps-zoom-btn plus" onclick="zoomIn()" aria-label="Zoom in">
                    <span class="material-icons">add</span>
                </button>
                <div class="zoom-divider"></div>
                <button class="gmaps-zoom-btn minus" onclick="zoomOut()" aria-label="Zoom out">
                    <span class="material-icons">remove</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Layers Menu (Popup) -->
    <div class="gmaps-layers-menu hidden" id="layers-menu">
        <div class="gmaps-layers-header">Capas del mapa</div>
        <label class="gmaps-layer-item">
            <input type="checkbox" checked onchange="toggleTrafficLayer(this.checked)">
            <span>Tr√°fico</span>
        </label>
        <label class="gmaps-layer-item">
            <input type="checkbox" onchange="toggleTransitLayer(this.checked)">
            <span>Transporte p√∫blico</span>
        </label>
        <label class="gmaps-layer-item">
            <input type="checkbox" onchange="toggleBicyclingLayer(this.checked)">
            <span>Ciclismo</span>
        </label>
        <div class="gmaps-layers-divider"></div>
        <div class="gmaps-layers-subheader">Chronos</div>
        <label class="gmaps-layer-item">
            <input type="checkbox" checked id="chronos-markers-toggle" onchange="toggleChronosMarkers(this.checked)">
            <span>Lugares hist√≥ricos</span>
        </label>
        <label class="gmaps-layer-item">
            <input type="checkbox" id="rare-only-toggle" onchange="toggleRareOnly(this.checked)">
            <span>Solo lugares raros</span>
        </label>
    </div>

    <!-- Legacy Modals (kept for compatibility) -->
    <div id="profile-creation-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h2 class="modal-title">Nueva Identidad</h2>
            <p style="color:#6b7280; font-size:14px; margin-bottom:20px;">Crea tu tarjeta de explorador para guardar tus
                hallazgos.</p>
            <div class="avatar-grid">
                <div class="avatar-option" onclick="selectAvatar('ü§†')">ü§†</div>
                <div class="avatar-option" onclick="selectAvatar('üë©‚ÄçüöÄ')">üë©‚ÄçüöÄ</div>
                <div class="avatar-option" onclick="selectAvatar('üïµÔ∏è‚Äç‚ôÄÔ∏è')">üïµÔ∏è‚Äç‚ôÄÔ∏è</div>
                <div class="avatar-option" onclick="selectAvatar('üßô‚Äç‚ôÇÔ∏è')">üßô‚Äç‚ôÇÔ∏è</div>
            </div>
            <input type="text" id="username-input" class="modal-input" placeholder="Nombre de Agente" maxlength="12">
            <button class="action-btn btn-primary" onclick="saveProfile()">
                Registrar Licencia <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <div id="chronodex-modal-v2" class="chronodex-modal-overlay hidden">
        <div class="chronodex-modal-card wide">
            <div class="modal-header">
                <h2 class="modal-title" style="margin:0"><i class="fa-solid fa-book-journal-whills"
                        style="color:#f59e0b;"></i> Chronodex
                </h2>
                <button class="close-btn"
                    onclick="document.getElementById('chronodex-modal-v2').classList.add('hidden')"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="margin-bottom:16px; font-size:13px; color:#94a3b8;">Tu colecci√≥n de descubrimientos hist√≥ricos.
            </div>
            <div id="chronodex-grid" class="chronedex-grid"></div>
        </div>
    </div>

    <div id="tours-modal" class="modal-overlay hidden">
        <div class="modal-card wide">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fa-solid fa-route" style="color:#8b5cf6;"></i> Rutas Guiadas</h2>
                <button class="close-btn" onclick="TourSystem.closeModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="margin-bottom:16px; font-size:13px; color:#6b7280;">Explora Barcelona con nuestras rutas
                curadas.</div>
            <div id="tours-grid" class="tours-grid"></div>
        </div>
    </div>

    <!-- Profile Overlay (AAA System) -->
    <div id="profile-overlay" class="profile-overlay hidden">
        <!-- Header Nav -->
        <div class="profile-header-nav">
            <button class="icon-btn-glass" onclick="ProfileSystem.close()">
                <span class="material-icons" style="vertical-align: middle;">close</span> Cerrar
            </button>
            <div style="flex:1"></div>
            <button class="icon-btn-glass"
                onclick="savePlayerState(); showToast('Progreso guardado', 'check', '#10b981')">
                <span class="material-icons" style="vertical-align: middle;">cloud_upload</span> Guardar
            </button>
        </div>

        <!-- Hero Section -->
        <div class="profile-hero">
            <div id="p-avatar-container" class="p-avatar-wrapper border-bronze">
                <span id="p-avatar">ü§†</span>
                <div class="online-indicator"></div>
            </div>
            <div class="p-identity">
                <div id="p-title" class="p-title-badge">EXPLORADOR NOVATO</div>
                <h1 id="p-username">@Agente</h1>
            </div>
        </div>

        <!-- Level & Progress -->
        <div class="level-section">
            <div class="level-info-row">
                <span id="p-level-display" style="color: white; font-weight: 800; font-size: 14px;">NIVEL 1</span>
                <span id="p-xp-text" style="color: #9ca3af; font-size: 12px;">0 / 1000 XP</span>
            </div>
            <div class="xp-bar-bg">
                <div id="p-xp-bar" class="xp-bar-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats-row">
            <div class="q-stat">
                <span id="stat-count-places" class="q-val">0</span>
                <span class="q-label">Lugares</span>
            </div>
            <div class="q-stat">
                <span id="stat-count-checkins" class="q-val">0</span>
                <span class="q-label">Visitas</span>
            </div>
            <div class="q-stat">
                <span id="stat-count-streak" class="q-val">1d</span>
                <span class="q-label">Racha</span>
            </div>
        </div>

        <!-- Bio Box -->
        <div class="p-bio-box" style="margin-top: 10px;">
            <p id="p-bio">Explorando el mundo un lugar a la vez üåç</p>
            <small id="p-joined">Miembro desde: --/--/----</small>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
            <button class="profile-tab-btn active" data-tab="discoveries">Descubrimientos</button>
            <button class="profile-tab-btn" data-tab="badges">Insignias</button>
        </div>

        <!-- Content Area -->
        <div class="profile-content-scroll">
            <!-- Discoveries Tab -->
            <div id="tab-discoveries" class="profile-tab-content">
                <div class="empty-msg">Cargando descubrimientos...</div>
            </div>

            <!-- Badges Tab -->
            <div id="tab-badges" class="profile-tab-content hidden">
                <div class="empty-msg">Cargando insignias...</div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-card" style="max-width: 400px;">
            <h2 class="modal-title">üîê Autenticaci√≥n</h2>

            <!-- Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                <button id="login-tab" class="auth-tab active" onclick="AuthSystem.switchAuthMode('login')">
                    Iniciar Sesi√≥n
                </button>
                <button id="register-tab" class="auth-tab" onclick="AuthSystem.switchAuthMode('register')">
                    Registrarse
                </button>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <input type="text" id="login-username" class="modal-input" placeholder="Nombre de usuario"
                    autocomplete="username">
                <input type="password" id="login-password" class="modal-input" placeholder="Contrase√±a"
                    autocomplete="current-password">
                <button class="action-btn btn-primary" onclick="AuthSystem.login()"
                    style="width: 100%; margin-top: 12px;">
                    Entrar <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <input type="text" id="register-username" class="modal-input" placeholder="Nombre de usuario"
                    autocomplete="username">
                <input type="password" id="register-password" class="modal-input" placeholder="Contrase√±a"
                    autocomplete="new-password">
                <input type="password" id="register-confirm" class="modal-input" placeholder="Confirmar contrase√±a"
                    autocomplete="new-password">
                <button class="action-btn btn-primary" onclick="AuthSystem.register()"
                    style="width: 100%; margin-top: 12px;">
                    Crear Cuenta <i class="fa-solid fa-user-plus"></i>
                </button>
            </div>

            <button class="action-btn" onclick="AuthSystem.hideAuthModal()"
                style="width: 100%; margin-top: 12px; background: #6b7280;">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <!-- Removed legacy chronodex-fix.js -->
    <script src="curated_content.js"></script>
    <script src="audio_fx.js"></script>
    <script src="chronodex.js?v=2"></script>
    <script src="rifts.js"></script>
    <script src="poster_generator.js"></script>
    <script src="profile.js"></script>
    <script src="tours.js"></script>
    <script src="google-services.js"></script>
    <script src="openai-services.js"></script>
    <script src="duels.js"></script>
    <script src="poi_card.js"></script>
    <script src="app.js"></script>

    <!-- Marker Clusterer -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt3-_T5sn-4xua9SdE7D7ENrXly3R4qAo&callback=initApp&libraries=places">
        </script>

    <script>
        function handleAuthFailure() {
            alert('Error: No se pudo cargar Google Maps. Verifica tu clave API.');
        }
    </script>
</body>

</html>